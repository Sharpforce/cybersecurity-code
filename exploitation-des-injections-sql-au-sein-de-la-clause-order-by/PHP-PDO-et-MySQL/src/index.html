<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>MySQL/PHP - Exploitation des injections SQL dans les clauses ORDER BY</title>
        <style>
            table {
                width: 80%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            table, th, td {
                border: 1px solid black;
            }
            th, td {
                padding: 10px;
                text-align: left;
            }
            input {
                margin-bottom: 10px;
            }
        </style>
    </head>
    <body>
        <h1>Users List</h1>
        <div>
            <label for="search-input">Search :</label>
            <input type="text" id="search-input" name="search" placeholder="Search ...">
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Firstname</th>
                    <th>Lastname</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody id="user-table-body">

            </tbody>
        </table>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var searchInput = document.getElementById('search-input');
                var tableBody = document.getElementById('user-table-body');

                loadDataFromAPI(searchInput.value.trim() || '');

                searchInput.addEventListener('input', function() {
                    var searchTerm = searchInput.value.trim();
                    loadDataFromAPI(searchTerm || '');
                });

                function loadDataFromAPI(searchTerm) {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status === 200) {
                                var response = xhr.responseText;
                                var data = response ? JSON.parse(response) : [];
                                updateTable(data);
                            } else {
                                console.error('Error retrieving data:', xhr.status, xhr.statusText);
                                displayError();
                            }
                        }
                    };

                    var url = './users';
                    url += '?search=' + encodeURIComponent(searchTerm) + "&sort=username&direction=ASC&page=1&maxPerPage=5";

                    xhr.open('GET', url);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send();
                }

                function updateTable(data) {
                    tableBody.innerHTML = '';

                    if (data && data.length > 0) {
                        data.forEach(function(user) {
                            var row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.firstname}</td>
                                <td>${user.lastname}</td>
                                <td>${user.email}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        displayNoResultsMessage();
                    }
                }

                function displayNoResultsMessage() {
                    tableBody.innerHTML = '<tr><td colspan="5">No result found</td></tr>';
                }

                function displayError() {
                    tableBody.innerHTML = '<tr><td colspan="5">Error retrieving data</td></tr>';
                }
            });
        </script>
    </body>
</html>
