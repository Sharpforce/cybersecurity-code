<?php
    header("Content-Type: application/json");

    $_bdd = array();
    $_bdd['server'] = 'db';
    $_bdd['port'] = '3306';
    $_bdd['user'] = 'sql_injection_in_pagination_clauses';
    $_bdd['password'] = 'passw0rd';
    $_bdd['database'] = 'sql_injection_in_pagination_clauses_database';
?>

<?php
    if ($_SERVER['REQUEST_METHOD'] == 'GET') {
        try {       
            $cnx = new PDO('pgsql:host='. $_bdd['server'] . ';dbname=' . $_bdd['database'], $_bdd['user'], $_bdd['password']);
            $cnx->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            
            $search = "%" . $_GET['search'] . "%";
            $page = ($_GET['page'] - 1) * $_GET['maxPerPage'];

            $stmt = $cnx->prepare("SELECT * FROM users WHERE username LIKE :search OR lastname LIKE :search OR firstname LIKE :search ORDER BY " . $_GET['sort'] . " " . $_GET['direction'] . " LIMIT :maxPerPage OFFSET :page");
            $stmt->bindParam(':search', $search, PDO::PARAM_STR);
            $stmt->bindParam(':maxPerPage', $_GET['maxPerPage'], PDO::PARAM_INT);
            $stmt->bindParam(':page', $page, PDO::PARAM_INT);
    
            $stmt->execute(); 
            $users = $stmt->fetchAll(PDO::FETCH_ASSOC);

            if ($users) {
                echo json_encode($users);
            }
            else {
                echo json_encode([]);
            }
        }
        catch(PDOException $e) {
            echo 'Error: ' . $e->getMessage();
            exit();
        }
    }
    else {
        http_response_code(405);
        echo json_encode(["message" => "Method not allowed"]);
    }    
?>